<?phprequire($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");  if (CModule::IncludeModule("advertising")){	$strBanner_right = CAdvBanner::Show("right_banner");	$strBanner_middle = CAdvBanner::Show("middle_banner");}$APPLICATION->SetPageProperty("title", "Кулинарные рецепты с фотографиями этапов приготовления. Foodclub.ru");$APPLICATION->SetPageProperty("description", "Кулинарные рецепты со всего света. Удобный поиск, пошаговые фотографии кулинарных рецептов.");$APPLICATION->SetPageProperty("keywords", "кулинарные рецепты, рецепт, кулинария, фото рецепты, рецепты с фотографиями, фото блюд");CModule::IncludeModule("blog");CModule::IncludeModule("socialnetwork");CModule::IncludeModule("iblock");require_once($_SERVER["DOCUMENT_ROOT"].'/classes/factory.class.php');require_once($_SERVER["DOCUMENT_ROOT"].'/classes/main.class.php');$CFClub = new CFClub;$CFactory = new CFactory;if($count = apc_fetch('getRecipesCount')){	//TODO:}else{	$count = $CFClub->getRecipesCount();	apc_add('getRecipesCount', $count, 3600);}if($online = apc_fetch('getOnlinecnt')){	//TODO:}else{	$online = $CFClub->getOnlineCount();	apc_add('getOnlinecnt', $online, 900);}/*if( $USER->IsAuthorized() ){	if($_REQUEST['l'] == "y")	{		if($_REQUEST['i'] == "a")		{			$_COOKIE['root_self'] = "N";			setcookie("root_self","N");		}		elseif($_REQUEST['i'] == "s")		{			$_COOKIE['root_self'] = "Y";			setcookie("root_self","Y");		}	}} else {	if($_REQUEST['l'] == "y")	{		LocalRedirect('/auth/?backurl=/?i=s&l=y');	}	else	{		$_COOKIE['root_self'] = "N";		setcookie("root_self","N");		}}*/$obCache = new CPHPCache;/** * Получаем список групп в зависимости от фильтрации по личным группам пользователя. */if($obCache->InitCache(86400, "arBlogs_index", "/")/* && $USER->IsAuthorized() && ($_REQUEST['i'] == "s" || $_COOKIE['root_self'] == "Y")*/){	$vars = $obCache->GetVars();	$arBlogs = $vars["arBlogs"];	$dbPosts = $vars["dbPosts"];}else{	/*$rsRel = CSocNetUserToGroup::GetList(Array(), Array(), false, false);	while($rs = $rsRel->GetNext()){		$arGroupProp['ID'][] = $rs['GROUP_ID'];	}	$rsGroup = CSocNetGroup::GetList(Array(), $arGroupProp, false, false);	while ($arGroup = $rsGroup->GetNext()) {		$arBlog = CBlog::GetBySocNetGroupID($arGroup['ID']);		$arBlogs[ $arBlog['ID'] ] = $arGroup;	}*/	$arFilter["<DATE_PUBLISH"] = ConvertTimeStamp($to, "FULL");	$dbPosts = CBlogPost::GetList(  Array("DATE_PUBLISH" => "DESC", "NAME" => "ASC"), 									Array("PUBLISH_STATUS" => BLOG_PUBLISH_STATUS_PUBLISH, /*"BLOG_ID" => array_keys($arBlogs),*/									"<=DATE_PUBLISH"=>ConvertTimeStamp(date(), "FULL"),									),									false,									Array('nPageSize'=>5)								 );	}?><div id="fc_statistics">	<div class="wrapper">		<span class="item">Добавлено <span class="num"><?=$count?></span> <a href="/all/"><?=$CFactory->plural_form($count, array("рецепт","рецепта","рецептов"));?></a></span><span class="sep"></span><span class="item"><span class="num"><?=$online?></span> <?=$CFactory->plural_form($online, array("кулинар","кулинара","кулинаров"));?> сейчас на сайте</span>	</div></div><?if(strlen($strBanner_middle) > 0){?><div id="hor_banner"><?=$strBanner_middle?></div><?}?><div id="content">	<div id="feed_space">		<div class="choice">			<noindex>			<a href="/blogs/">Все клубы</a>			<?if($USER->IsAuthorized()){?>				<a href="/personal/lenta.php">Моя лента</a>			<?}?>			</noindex>		</div>		<h2>Темы, обсуждаемые в клубах</h2><?$Nav_string = $dbPosts->GetPageNavString("", "blogs");	//Parser class$parser = new blogTextParser;if(!isset($arBlogs)){	$arBlogs = array();}if($obCache->StartDataCache()){	$bFirst = true;	while($arPost = $dbPosts->Fetch()){		if(intval($arPost["BLOG_ID"]) > 0 && !isset($arBlogs[ $arPost["BLOG_ID"] ])){			//$rsGroup = CSocNetGroup::GetByID($arPost["BLOG_ID"]);			//if($arGroup = $rsGroup->GetNext()){			//if($arGroup = CSocNetGroup::GetByID($arPost["BLOG_ID"])){			if($arBlog = CBlog::GetByID($arPost["BLOG_ID"])){				//$arBlog = CBlog::GetBySocNetGroupID($arGroup['ID']);				$arBlogs[ $arBlog["ID"] ] = $arBlog;			}		}		if($dbCategory = apc_fetch('dbCategory')){			//TODO:			$dbCategory = unserialize($dbCategory);		}else{			$dbCategory = CBlogPostCategory::GetList(Array("NAME" => "ASC"), Array("BLOG_ID" => $arPost["BLOG_ID"], "POST_ID" => $arPost["ID"]));			apc_add('dbCategory', serialize($dbCategory), 86400);		}		while($arCategory = $dbCategory->GetNext()){			$arCatTmp = $arCategory;			$arCatTmp["urlToCategory"] = "/blogs/group/".$arBlogs[ $arPost['BLOG_ID'] ]['ID']."/blog/?category=".$arCatTmp['CATEGORY_ID'];			$arPost["CATEGORY"][] = $arCatTmp;		}											$arPost['urlToDelete'] = "/blogs/group/".$arBlogs[ $arPost['BLOG_ID'] ]['ID']."/blog/?del_id=".$arPost['ID'];		$res = CBlogImage::GetList(array("ID"=>"ASC"), array("POST_ID"=>$arPost['ID'], "BLOG_ID"=>$arPost['BLOG_ID']));				while ($arImage = $res->Fetch())		    $arImages[$arImage['ID']] = $arImage['FILE_ID'];				$arParserParams = Array(			"imageWidth" => "465",			"imageHeight" => "600",		);				$arAllow = array("HTML" => "N", "ANCHOR" => "Y", "BIU" => "Y", "IMG" => "Y", "QUOTE" => "Y", "CODE" => "Y", "FONT" => "Y", "LIST" => "Y", "SMILES" => "Y", "NL2BR" => "N", "VIDEO" => "Y");				$text = $parser->convert($arPost['DETAIL_TEXT'], true, $arImages, $arAllow, $arParserParams);		if (preg_match("/(\[CUT\])/i",$arPost['DETAIL_TEXT']) || preg_match("/(<CUT>)/i",$arPost['DETAIL_TEXT']))			$arPost["CUT"] = "Y";	    		$rsUser = CUser::GetByID($arPost['AUTHOR_ID']);		$arUser = $rsUser->Fetch();				if(intval($arUser['PERSONAL_PHOTO']) > 0){			$rsAvatar = CFile::GetByID($arUser['PERSONAL_PHOTO']);			$arAvatar = $rsAvatar->Fetch();			$arAvatar['SRC'] = "/upload/".$arAvatar['SUBDIR']."/".$arAvatar['FILE_NAME'];		} else {			$arAvatar['SRC'] = "/images/avatar/avatar_small.jpg";		}				$arDate = explode(" ", $arPost['DATE_PUBLISH']);?>		<?if($bFirst){		$bFirst = false;?>		<div class="topic_item">			<div class="chain_path"><a href="/blogs/group/<?=$arBlogs[ $arPost['BLOG_ID'] ]['SOCNET_GROUP_ID']?>/blog/"><?=str_replace("Блог группы ","",$arBlogs[ $arPost['BLOG_ID'] ]['NAME'])?></a></div>						<h3><a class="heading" href="/blogs/group/<?=$arBlogs[ $arPost['BLOG_ID'] ]['SOCNET_GROUP_ID']."/blog/".$arPost['ID']?>/"><?=$arPost['TITLE']?></a>			<?/*if($USER->IsAdmin() || $USER->GetID() == $arPost['AUTHOR_ID']):?>				<span class="admin_panel"><noindex>					<a title="Редактировать запись" href="/blogs/group/<?=$arBlogs[ $arPost['BLOG_ID'] ]['SOCNET_GROUP_ID']."/blog/edit/".$arPost['ID']?>/" class="edit">						Редактировать запись					</a>					<a title="Удалить запись" class="delete" href="javascript:if(confirm('Вы действительно хотите удалить этот пост?')) window.location='<?=$arPost["urlToDelete"]."&".bitrix_sessid_get()?>'">						Удалить запись					</a>				</noindex></span>			<?endif;*/?>			</h3>			<div class="text"><?=$text?>			<?if($arPost['CUT'] == "Y"){?>					<div class="fcut"><a href="/blogs/group/<?=$arBlogs[ $arPost['BLOG_ID'] ]['SOCNET_GROUP_ID']."/blog/".$arPost['ID']?>/#cut">Подробнее</a></div>				<?}?>			</div>			<?if(isset($arPost['CATEGORY'])){ $bFirst = true;?>				<div class="tags">					<h6>Метки</h6>					<?foreach($arPost['CATEGORY'] as $Item){?>						<?if(!$bFirst){echo ", ";}else{$bFirst = false;}?><a href="<?=$Item['urlToCategory']?>"><?=$Item['NAME']?></a>					<?}?>				</div>			<?}?>			<div class="bar">				<span class="comments_icon" title="Комментировать"><noindex>					<a href="/blogs/group/<?=$arBlogs[ $arPost['BLOG_ID'] ]['SOCNET_GROUP_ID']."/blog/".$arPost['ID']?>/#00"><?=(intval($arPost['NUM_COMMENTS']) > 0 ? intval($arPost['NUM_COMMENTS']) : "" )?></a>				</noindex></span>				<span class="author">					<noindex>						<span class="photo">&nbsp;<a href="/profile/<?=$arUser['ID']?>/">							<img src="<?=$arAvatar['SRC']?>" width="30" height="30" alt="<?=$arUser['LOGIN']?>" />						</a></span>						<a href="/profile/<?=$arUser['ID']?>/"><?=$arUser['LOGIN']?></a>					</noindex>				</span>				<span class="date"><?=CFactory::humanDate($arDate[0])?> <?=$arDate[1]?></span>				<div class="clear"></div>			</div>		</div>		<?}else{?>			<div class="topic_item_brief">				<div class="bar">					<span class="comments_icon" title="Комментировать"><noindex>						<a href="/blogs/group/<?=$arBlogs[ $arPost['BLOG_ID'] ]['SOCNET_GROUP_ID']."/blog/".$arPost['ID']?>/#00"><?=(intval($arPost['NUM_COMMENTS']) > 0 ? intval($arPost['NUM_COMMENTS']) : "" )?></a>					</noindex></span>				</div>				<h3><a class="heading" href="/blogs/group/<?=$arBlogs[ $arPost['BLOG_ID'] ]['SOCNET_GROUP_ID']."/blog/".$arPost['ID']?>/"><?=$arPost['TITLE']?></a>				<?/*if($USER->IsAdmin() || $USER->GetID() == $arPost['AUTHOR_ID']):?>					<span class="admin_panel"><noindex>						<a title="Редактировать запись" href="/blogs/group/<?=$arBlogs[ $arPost['BLOG_ID'] ]['SOCNET_GROUP_ID']."/blog/edit/".$arPost['ID']?>/" class="edit">							Редактировать запись						</a>						<a title="Удалить запись" class="delete" href="javascript:if(confirm('Вы действительно хотите удалить этот пост?')) window.location='<?=$arPost["urlToDelete"]."&".bitrix_sessid_get()?>'">							Удалить запись						</a>					</noindex></span>				<?endif;*/?>				</h3>				<div class="clear"></div>			</div>		<?}?>	<?}	$obCache->EndDataCache(Array(			"arBlogs"  => $arBlogs,			"dbPosts"  => $dbPosts,		));?><?}?>	</div>	<div id="cooks_space">		<div id="cooks_feed">			<?$APPLICATION->IncludeComponent("custom:topcook.list", "topcook.index.new", Array(				"DISPLAY_DATE" => "Y",	// Выводить дату элемента				"DISPLAY_NAME" => "Y",	// Выводить название элемента				"DISPLAY_PICTURE" => "Y",	// Выводить изображение для анонса				"DISPLAY_PREVIEW_TEXT" => "Y",	// Выводить текст анонса				"AJAX_MODE" => "N",	// Включить режим AJAX				"IBLOCK_TYPE" => "news",	// Тип информационного блока (используется только для проверки)				"IBLOCK_ID" => "",	// Код информационного блока				"NEWS_COUNT" => "20",	// Количество новостей на странице				"SORT_BY1" => "ACTIVE_FROM",	// Поле для первой сортировки новостей				"SORT_ORDER1" => "DESC",	// Направление для первой сортировки новостей				"SORT_BY2" => "SORT",	// Поле для второй сортировки новостей				"SORT_ORDER2" => "ASC",	// Направление для второй сортировки новостей				"FILTER_NAME" => "",	// Фильтр				"FIELD_CODE" => "",	// Поля				"PROPERTY_CODE" => "",	// Свойства				"CHECK_DATES" => "Y",	// Показывать только активные на данный момент элементы				"DETAIL_URL" => "",	// URL страницы детального просмотра (по умолчанию - из настроек инфоблока)				"PREVIEW_TRUNCATE_LEN" => "",	// Максимальная длина анонса для вывода (только для типа текст)				"ACTIVE_DATE_FORMAT" => "d.m.Y",	// Формат показа даты				"SET_TITLE" => "Y",	// Устанавливать заголовок страницы				"SET_STATUS_404" => "N",	// Устанавливать статус 404, если не найдены элемент или раздел				"INCLUDE_IBLOCK_INTO_CHAIN" => "Y",	// Включать инфоблок в цепочку навигации				"ADD_SECTIONS_CHAIN" => "Y",	// Включать раздел в цепочку навигации				"HIDE_LINK_WHEN_NO_DETAIL" => "N",	// Скрывать ссылку, если нет детального описания				"PARENT_SECTION" => "",	// ID раздела				"PARENT_SECTION_CODE" => "",	// Код раздела				"CACHE_TYPE" => "A",	// Тип кеширования				"CACHE_TIME" => "36000000",	// Время кеширования (сек.)				"CACHE_NOTES" => "",				"CACHE_FILTER" => "N",	// Кэшировать при установленном фильтре				"CACHE_GROUPS" => "Y",	// Учитывать права доступа				"DISPLAY_TOP_PAGER" => "N",	// Выводить над списком				"DISPLAY_BOTTOM_PAGER" => "Y",	// Выводить под списком				"PAGER_TITLE" => "Новости",	// Название категорий				"PAGER_SHOW_ALWAYS" => "Y",	// Выводить всегда				"PAGER_TEMPLATE" => "",	// Название шаблона				"PAGER_DESC_NUMBERING" => "N",	// Использовать обратную навигацию				"PAGER_DESC_NUMBERING_CACHE_TIME" => "36000",	// Время кеширования страниц для обратной навигации				"PAGER_SHOW_ALL" => "Y",	// Показывать ссылку "Все"				"AJAX_OPTION_SHADOW" => "Y",	// Включить затенение				"AJAX_OPTION_JUMP" => "N",	// Включить прокрутку к началу компонента				"AJAX_OPTION_STYLE" => "Y",	// Включить подгрузку стилей				"AJAX_OPTION_HISTORY" => "N",	// Включить эмуляцию навигации браузера				"AJAX_OPTION_ADDITIONAL" => "",	// Дополнительный идентификатор				),				false			);?>		</div>	</div>	<div id="banner_space" class="index">		<?if(strlen($strBanner_right) > 0){?><div class="banner"><h5>Реклама</h5><?=$strBanner_right?></div><?}?>		<div class="comments_feed">			<?$APPLICATION->IncludeComponent("custom:blog.new_comments", ".default", array(	"GROUP_ID" => "1",	"BLOG_URL" => "",	"COMMENT_COUNT" => "6",	"MESSAGE_LENGTH" => "100",	"DATE_TIME_FORMAT" => "d.m.Y H:i:s",	"PATH_TO_BLOG" => "/blogs/group/#blog#/blog/",	"PATH_TO_POST" => "/blogs/group/#blog#/blog/#post_id#/",	"PATH_TO_USER" => "/profile/#user_id#/",	"PATH_TO_GROUP_BLOG_POST" => "",	"CACHE_TYPE" => "A",	"CACHE_TIME" => "600",	"PATH_TO_SMILE" => "",	"BLOG_VAR" => "",	"POST_VAR" => "",	"USER_VAR" => "",	"PAGE_VAR" => "",	"SEO_USER" => "N"	),	false);?>		</div>	</div>	<div class="clear"></div>	<div class="collection_block">		<h2><span>Подборка</span></h2>		<?		if($Themes = apc_fetch('Tms')){			$Themes = unserialize($Themes);			$ResDump = apc_fetch('ResDump');			$ResDump = unserialize($ResDump);			$strBlockHTML = apc_fetch('strBlockHTML');			$strBlockHTML = unserialize($strBlockHTML);		}else{			$rsThematicBlock = CIBlockElement::GetList( Array("SORT"=>"ASC"), 											Array("ACTIVE"=>"Y", "IBLOCK_CODE"=>"thematic_bloc", "PROPERTY_place_VALUE"=>"home"),											false,											false,											Array("ID", "NAME", "PREVIEW_PICTURE", "PROPERTY_recipe", "PROPERTY_place")										);			$ResDump = Array();			while($Bl = $rsThematicBlock->GetNext())			{				$ResDump[ $Bl['ID'] ][] = $Bl['PROPERTY_RECIPE_VALUE'];								if(!isset( $Themes[ $Bl['ID'] ] ))				{					$Themes[ $Bl['ID'] ] = $Bl;				}			}			$strBlockHTML = array();			foreach($Themes as $Block){				$rsRecipes = CIBlockElement::GetList(Array("SORT"=>"ASC"), Array("ID"=>$ResDump[ $Block['ID'] ]), false, false, Array("ID", "NAME", "CREATED_BY", "PREVIEW_PICTURE", "PROPERTY_comment_count"));				while($arRecipe = $rsRecipes->GetNext()){					$rsUser = CUser::GetByID($arRecipe['CREATED_BY']);					$arUser = $rsUser->Fetch();										$arRecipe['USER'] = $arUser;										//$strBlockHTML .= '<a href="/detail/'.$arRecipe['ID'].'/">'.$arRecipe['NAME'].'</a>&nbsp;<span class="comments">(<a href="/detail/'.$arRecipe['ID'].'/#comments">'.IntVal($arRecipe['PROPERTY_COMMENT_COUNT_VALUE']).'</a>)</span><span class="author">От: '.$arRecipe['USER']['LOGIN'].'</span>';					$strBlockHTML[ $Block["ID"] ] .= '<div class="recipe_list_item">';					if(intval($arRecipe["PREVIEW_PICTURE"]) > 0){						$arFile = CFile::GetFileArray($arRecipe["PREVIEW_PICTURE"]);						$strBlockHTML[ $Block["ID"] ] .= '<div class="photo"><a title="'.$arRecipe['NAME'].'" href="/detail/'.$arRecipe['ID'].'/">';						$strBlockHTML[ $Block["ID"] ] .= '<img width="150" alt="'.$arRecipe['NAME'].'" src="'.$arFile['SRC'].'"></a></div>';					}					$strBlockHTML[ $Block["ID"] ] .= '<h5><a href="/detail/'.$arRecipe['ID'].'/">'.$arRecipe['NAME'].'</a></h5>';					$strBlockHTML[ $Block["ID"] ] .= '<p class="author">От: '.$arRecipe['USER']['LOGIN'].'</p>';					$strBlockHTML[ $Block["ID"] ] .= '</div>';				}			}			apc_add('Tms', serialize($Themes), 86400);			apc_add('ResDump', serialize($ResDump), 86400);			apc_add('strBlockHTML', serialize($strBlockHTML), 86400);		}		//echo "<pre>"; print_r($Themes); echo "</pre>";		//echo "<pre>"; print_r($ResDump); echo "</pre>";		foreach($Themes as $Block){?>			<div class="block">				<h3><?=$Block['NAME']?></h3>				<?=$strBlockHTML[ $Block["ID"] ]?>				<div class="clear"></div>			</div>		<?}?>	</div></div><?require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");?>